name: Post Latest Blog from RSS to Bluesky

on:
  workflow_dispatch:
    inputs:
      skip_date_check:
        description: "Skip the date check and post anyway"
        required: false
        type: boolean
        default: false

env:
  RSS_FEED_URL: ${{ vars.RSS_FEED_URL || 'https://yearofthegeek.net/feed' }}

jobs:
  fetch-and-post:
    runs-on: ubuntu-latest

    steps:
      # Initial delay (reduced from 2 minutes since manual runs don't need as much delay)
      - name: Initial Delay
        run: |
          echo "Waiting for 10 seconds before starting..."
          sleep 10

      # Checkout repository to access posted URLs tracking
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # Cache apt packages
      - name: Cache apt packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libxml2-utils
          version: 1.0

      # Install required tools
      - name: Install xmllint
        run: |
          sudo apt-get update && sudo apt-get install -y libxml2-utils

      # Fetch the latest blog post from RSS feed
      - name: Fetch Latest Blog Post
        id: fetch_post
        run: |
          echo "Fetching RSS feed from: $RSS_FEED_URL"

          # Fetch RSS feed
          response=$(curl -s "$RSS_FEED_URL")

          # Check if we got a response
          if [[ -z "$response" ]]; then
            echo "Error: Empty response from RSS feed. Exiting."
            exit 1
          fi

          # Parse the first <item> (Debugging)
          first_item=$(echo "$response" | xmllint --xpath "//item[1]" - 2>/dev/null || echo "PARSE_ERROR")
          echo "First Item: $first_item"

          # Parse specific fields from the first <item>
          description=$(echo "$response" | xmllint --xpath "string(//item[1]/description)" - 2>/dev/null || echo "PARSE_ERROR")
          url=$(echo "$response" | xmllint --xpath "string(//item[1]/link)" - 2>/dev/null || echo "PARSE_ERROR")
          pub_date=$(echo "$response" | xmllint --xpath "string(//item[1]/pubDate)" - 2>/dev/null || echo "PARSE_ERROR")

          # Log parsed data
          echo "Parsed Data - Description: $description, URL: $url, PubDate: $pub_date"

          # Handle parsing errors
          if [[ "$description" == "PARSE_ERROR" || "$url" == "PARSE_ERROR" || "$pub_date" == "PARSE_ERROR" ]]; then
            echo "Error: Failed to parse one or more required fields from the RSS feed. Exiting."
            exit 1
          fi

          # Check if URL has already been posted
          POSTED_FILE=".github/bluesky-posted-urls.txt"
          if [[ -f "$POSTED_FILE" ]] && grep -Fxq "$url" "$POSTED_FILE"; then
            echo "This URL has already been posted to Bluesky: $url"
            echo "Exiting to prevent duplicate post."
            exit 0
          fi

          # Extract and compare dates (skip if override is enabled)
          if [[ "${{ inputs.skip_date_check }}" == "true" ]]; then
            echo "Date check skipped via input parameter."
          else
            today=$(date -u +%Y-%m-%d)
            pub_date_parsed=$(date -d "$pub_date" -u +%Y-%m-%d 2>/dev/null || echo "PARSE_ERROR")

            echo "Today's Date (UTC): $today"
            echo "Publication Date (UTC): $pub_date_parsed"

            if [[ "$pub_date_parsed" == "PARSE_ERROR" ]]; then
              echo "Error: Could not parse publication date. Exiting."
              exit 1
            fi

            if [[ "$pub_date_parsed" != "$today" ]]; then
              echo "The blog post is not from today ($pub_date_parsed). Exiting."
              exit 0
            fi
          fi

          # Format and export environment variables
          description=$(echo "$description" | xargs)

          echo "Raw description: $description"
          echo "URL: $url"

          # Truncate description if needed to fit Bluesky's 300 character limit
          # Account for URL length and spacing
          url_length=${#url}
          max_desc_length=$((297 - url_length))  # 297 to account for space before URL

          if [[ ${#description} -gt $max_desc_length ]]; then
            description="${description:0:$max_desc_length}..."
          fi

          preview="$description $url"

          # Export to both GITHUB_ENV and GITHUB_OUTPUT
          echo "preview=$preview" >> $GITHUB_ENV
          echo "rss_url=$url" >> $GITHUB_ENV
          echo "preview=$preview" >> $GITHUB_OUTPUT
          echo "rss_url=$url" >> $GITHUB_OUTPUT

          echo "Final preview text: $preview"
          echo "Final preview text length: ${#preview}"

          # Verify exports worked
          if [[ -z "$preview" ]] || [[ -z "$url" ]]; then
            echo "Error: Failed to set preview or URL variables. Exiting."
            exit 1
          fi

      # Post to Bluesky
      - name: Post to Bluesky
        if: steps.fetch_post.outputs.preview != '' && steps.fetch_post.outputs.rss_url != ''
        uses: myConsciousness/bluesky-post@v5
        with:
          text: "${{ steps.fetch_post.outputs.preview }}"
          link-preview-url: "${{ steps.fetch_post.outputs.rss_url }}"
          identifier: ${{ secrets.BLUESKY_IDENTIFIER }}
          password: ${{ secrets.BLUESKY_PASSWORD }}

      # Track posted URL to prevent duplicates
      - name: Record Posted URL
        if: success() && steps.fetch_post.outputs.rss_url != ''
        run: |
          POSTED_FILE=".github/bluesky-posted-urls.txt"
          mkdir -p .github
          echo "${{ steps.fetch_post.outputs.rss_url }}" >> "$POSTED_FILE"

          # Keep only the last 100 URLs to prevent file from growing too large
          if [[ $(wc -l < "$POSTED_FILE") -gt 100 ]]; then
            tail -n 100 "$POSTED_FILE" > "$POSTED_FILE.tmp"
            mv "$POSTED_FILE.tmp" "$POSTED_FILE"
          fi

          echo "Recorded URL to tracking file"
          cat "$POSTED_FILE"

      # Commit the updated tracking file
      - name: Commit Posted URLs
        if: success() && steps.fetch_post.outputs.rss_url != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/bluesky-posted-urls.txt

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Track posted URL: ${{ steps.fetch_post.outputs.rss_url }}"
            git push
            echo "Successfully committed and pushed tracking file"
          fi

      # Debug step: Print environment variables (optional, remove after debugging)
      - name: Debug Environment Variables
        if: always()
        run: |
          echo "Preview Text: ${{ env.preview }}"
          echo "RSS URL: ${{ env.rss_url }}"
          echo "RSS Feed URL: $RSS_FEED_URL"
